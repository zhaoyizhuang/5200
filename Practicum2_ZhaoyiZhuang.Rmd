---
title: "CS5200 Practicum2"
author: "Zhaoyi Zhuang"
output: html_notebook
---

# Part 1
## Part1 Question1 
![](/Users/zhaoyizhuang/5200/Practicum2/P2Q1ERD.png)

## Create the database
```{r}
library(RSQLite)

fpath = "/Users/zhaoyizhuang/5200/Practicum2/"
dbfile = "p2DB.sqlite"

# if database file already exists, we connect to it, otherwise
# we create a new database
dbcon <- dbConnect(RSQLite::SQLite(), paste0(fpath,dbfile))
```

## Part1 Question2 Relational Schema
```{sql connection=dbcon}
PRAGMA foreign_keys = ON
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Journal
```

```{sql connection=dbcon}
CREATE TABLE Journal(
  ISSN TEXT NOT NULL,
  Title TEXT NOT NULL,
  PRIMARY KEY (ISSN)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Author
```

```{sql connection=dbcon}
CREATE TABLE Author(
  AuthorId TEXT NOT NULL,
  LastName TEXT NOT NULL,
  FirstName TEXT NOT NULL,
  Initials TEXT NOT NULL,
  PRIMARY KEY (AuthorId)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS History
```

```{sql connection=dbcon}
CREATE TABLE History(
  HistoryId TEXT NOT NULL,
  received DATE,
  accepted DATE,
  entrez DATE NOT NULL,
  medline DATE NOT NULL,
  PRIMARY KEY (HistoryId)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Article
```

```{sql connection=dbcon}
CREATE TABLE Article(
  PMID TEXT NOT NULL,
  ArticleTitle TEXT NOT NULL,
  Volume TEXT NOT NULL,
  Issue TEXT NOT NULL,
  DateCreated DATE NOT NULL,
  PubDate DATE NOT NULL,
  ISSN TEXT NOT NULL,
  HistoryId TEXT NOT NULL,
  PRIMARY KEY (PMID),
  FOREIGN KEY (ISSN) REFERENCES Journal(ISSN),
  FOREIGN KEY (HistoryId) REFERENCES History(HistoryId)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Write
```

```{sql connection=dbcon}
CREATE TABLE Write(
  PMID TEXT NOT NULL,
  AuthorId TEXT NOT NULL,
  PRIMARY KEY (PMID, AuthorId),
  FOREIGN KEY (AuthorId) REFERENCES Author(AuthorId), 
  FOREIGN KEY (PMID) REFERENCES Article(PMID)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Affiliation
```

```{sql connection=dbcon}
CREATE TABLE Affiliation(
  Department TEXT NOT NULL,
  PRIMARY KEY (Department)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Affiliate
```

```{sql connection=dbcon}
CREATE TABLE Affiliate(
  Department TEXT NOT NULL,
  AuthorId TEXT NOT NULL,
  PRIMARY KEY (Department, AuthorId),
  FOREIGN KEY (AuthorId) REFERENCES Author(AuthorId), 
  FOREIGN KEY (Department) REFERENCES Affiliation(Department)
)
```

## Part1 Question3
## Load the XML file
```{r}
library("XML")
library("methods")

path <- "/Users/zhaoyizhuang/5200/Practicum2/"
xmlFile <- "pubmed_sample.xml"
fp <- paste0(path,xmlFile)

xmlObj <- xmlParse(fp)
root <- xmlRoot(xmlObj)
size <- xmlSize(root)
```
## Self-defined function helping read the xml
```{r}
readFromXml <- function(xpathEx) {
  result <- xpathSApply(xmlObj, xpathEx, xmlValue)
}

```

## Create and Populate Journal table. Note: Volume, Issue and Pubdate info will be contained in Article
```{r}
ISSN <- readFromXml("//Article/Journal/ISSN")
Title <- readFromXml("//Article/Journal/Title")
Journal <- cbind(ISSN, Title)
Journal <- Journal[!duplicated(Journal), ]
Journal <- data.frame(Journal)
Journal
```


## Create and Populate the Article table. Assumption: The PubDate for an article is the date for pubmed: date the citation was added to PubMed.
```{r}
PMID <- readFromXml("//MedlineCitation/PMID")
ArticleTitle <- readFromXml("//ArticleTitle")
DateCreated <- vector()
PubDate <- vector()
Volume <- readFromXml("//Article/Journal/JournalIssue/Volume")
Issue <- readFromXml("//Article/Journal/JournalIssue/Issue")
ISSN <- readFromXml("//Article/Journal/ISSN")

for (i in 1:size) {
  curr <- root[[i]][[2]][[1]]
  for (e in 1:xmlSize(curr)) {
    a <- xmlAttrs(curr[[e]])[[1]]
    if (a == "pubmed") {
      PubDate <- append(PubDate, (paste(xmlValue(curr[[e]][[2]]), xmlValue(curr[[e]][[3]]), xmlValue(curr[[e]][[1]]), sep = "/")))
    }
  }
}

for (i in 1:size) {
  curr <- root[[i]][[1]][[2]]
  date <- paste(xmlValue(curr[[2]]), xmlValue(curr[[3]]), xmlValue(curr[[1]]), sep = "/")
  DateCreated <- append(DateCreated, date)
}

Article <- cbind(PMID, ArticleTitle, DateCreated, PubDate, Volume, Issue, ISSN)
Article <- data.frame(Article)
Article$DateCreated <- as.Date(Article$DateCreated, format = "%m/%d/%Y")
Article$PubDate <- as.Date(Article$PubDate, format = "%m/%d/%Y")
Article
```


## Create and Populate Author table
```{r}
Affiliation <- vector()
LastName <- vector()
FirstName <- vector()
Initials <- vector()

for (i in 1:size) {
  for (e in 1:xmlSize(root[[i]][[1]])) {
    if (xmlName(root[[i]][[1]][[e]]) == "Article")
      for (s in 1:xmlSize(root[[i]][[1]][[e]])) {
        if (xmlName(root[[i]][[1]][[e]][[s]]) == "AuthorList") {
          curr <- root[[i]][[1]][[e]][[s]]
          for (f in 1:xmlSize(curr)) {
            LastName <- append(LastName, xmlValue(curr[[f]][[1]]))
            FirstName <- append(FirstName, xmlValue(curr[[f]][[2]]))
            Initials <- append(Initials, xmlValue(curr[[f]][[3]]))
            cc <- xmlValue(curr[[f]][[4]])
            if (!(is.na(cc))) {
              Affiliation <- append(Affiliation, cc)
            }
            
          }
        }
      }
  }
}

Author <- cbind(LastName, FirstName, Initials)
Author <- Author[!duplicated(Author), ]

AuthorId = 1:nrow(Author)

Author <- cbind(Author, AuthorId)
Author <- data.frame(Author)
Author
```

## Create and Populate the Affiliation table, this is the table for affiliation of authors.
```{r}
Affiliation <- Affiliation[!duplicated(Affiliation)]
Affiliation <- data.frame(Affiliation)
Affiliation
```

## Create and Populate the Affiliate table, this is the lookup table to connect Author table and Affiliation table.
```{r}
Affiliate_AuthorId <- vector()
Affiliate_DepartmentId <- vector()
for (i in 1:size) {
  for (e in 1:xmlSize(root[[i]][[1]])) {
    if (xmlName(root[[i]][[1]][[e]]) == "Article")
      for (s in 1:xmlSize(root[[i]][[1]][[e]])) {
        if (xmlName(root[[i]][[1]][[e]][[s]]) == "AuthorList") {
          curr <- root[[i]][[1]][[e]][[s]]
          LastName <- xmlValue(curr[[1]][[1]])
          FirstName <- xmlValue(curr[[1]][[2]])
          Initials <- xmlValue(curr[[1]][[3]])
          fff <- xmlValue(curr[[1]][[4]])
          for (v in 1 : nrow(Author)) {
            if (LastName == Author$LastName[v] & FirstName == Author$FirstName[v] 
                  & Initials == Author$Initials[v]) {
              Affiliate_AuthorId <- append(Affiliate_AuthorId, as.character(Author$AuthorId[v]))
                  }
          }
          Affiliate_DepartmentId <- append(Affiliate_DepartmentId, fff)
          
        }
      }
  }
}

Affiliate <- cbind(Affiliate_DepartmentId, Affiliate_AuthorId)
Affiliate <- Affiliate[!duplicated(Affiliate), ]
Affiliate <- data.frame(Affiliate)
Affiliate
```

## Create Write table, it is a look up table represents the relationship between author and article.
```{r}
AuthorList_Id <- vector()
AuthorList_AuthorId <- vector()
Author_count <- 1
ff <- vector()
gg <- vector()

for (i in 1:size) {
  pid <- xmlValue(root[[i]][[1]][[1]])
  for (e in 1:xmlSize(root[[i]][[1]])) {
    if (xmlName(root[[i]][[1]][[e]]) == "Article")
      for (s in 1:xmlSize(root[[i]][[1]][[e]])) {
        if (xmlName(root[[i]][[1]][[e]][[s]]) == "AuthorList") {
          curr <- root[[i]][[1]][[e]][[s]]
          for (f in 1:xmlSize(curr)) {
            LastName <- xmlValue(curr[[f]][[1]])
            FirstName <- xmlValue(curr[[f]][[2]])
            Initials <- xmlValue(curr[[f]][[3]])
            
            for(v in 1 : nrow(Author)) {
              if (LastName == Author$LastName[v] & FirstName == Author$FirstName[v] 
                  & Initials == Author$Initials[v]) {
                
                AuthorList_Id <- append(AuthorList_Id, Author_count)
                AuthorList_AuthorId <- append(AuthorList_AuthorId, as.character(Author$AuthorId[v]))
                ff <- append(ff, as.character(Author$AuthorId[v]))
                gg <- append(gg, pid)
                break;
              }
            }
          }
        }
      }
    }
  Author_count <- Author_count + 1
}


Write <- cbind(ff, gg)
Write <- data.frame(Write)
names(Write) <- c("AuthorId", "PMID")
Write
```

## Create the History table
```{r}
received <- vector()
accepted <- vector()
entrez <- vector()
medline <- vector()

Year <- vector()
Month <- vector()
Day <- vector()

for (i in 1:size) {
  curr <- root[[i]][[2]][[1]]
  hasR <- FALSE
  hasA <- FALSE
  for (e in 1:xmlSize(curr)) {
    a <- xmlAttrs(curr[[e]])[[1]]
    if (a == "entrez") {
      entrez <- append(entrez, (paste(xmlValue(curr[[e]][[2]]), xmlValue(curr[[e]][[3]]), xmlValue(curr[[e]][[1]]), sep = "/")))
    } 
    if (a == "received") {
      received <- append(received, (paste(xmlValue(curr[[e]][[2]]), xmlValue(curr[[e]][[3]]), xmlValue(curr[[e]][[1]]), sep = "/")))
      hasR <- TRUE
    }
    if (a == "accepted") {
      accepted <- append(accepted, (paste(xmlValue(curr[[e]][[2]]), xmlValue(curr[[e]][[3]]), xmlValue(curr[[e]][[1]]), sep = "/")))
      hasA <- TRUE
    }
    if (a == "pubmed") {
      Year <- append(Year, xmlValue(curr[[e]][[1]]))
      Month <- append(Month, xmlValue(curr[[e]][[2]]))
      Day <- append(Day, xmlValue(curr[[e]][[3]]))
    }
    if (a == "medline") {
      medline <- append(medline, (paste(xmlValue(curr[[e]][[2]]), xmlValue(curr[[e]][[3]]), xmlValue(curr[[e]][[1]]), sep = "/")))
    }
  }
  if (!(hasR)) {
    received <- append(received, NA)
  }
  if (!(hasA)) {
    accepted <- append(accepted, NA)
  }
}

History <- cbind(received, accepted, entrez, medline)
History <- History[!duplicated(History), ]

HistoryId = 1:nrow(History)

History <- cbind(History, HistoryId)
History <- data.frame(History)
History$received <- as.Date(History$received, format = "%m/%d/%Y")
History$accepted <- as.Date(History$accepted, format = "%m/%d/%Y")
History$entrez <- as.Date(History$entrez, format = "%m/%d/%Y")
History$medline <- as.Date(History$medline, format = "%m/%d/%Y")
History
```

## Add History ID to the Article table
```{r}
Article <- cbind(Article, HistoryId)
Article
```


```{r}
Affiliation
```

## Write table to the database
```{r}
dbWriteTable(conn = dbcon, 
             name = "Journal", 
             value = Journal,
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Author", 
             value = Author,
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "History", 
             value = History,
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Article", 
             value = Article,
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Write", 
             value = Write,
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Affiliate", 
             value = Affiliate,
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Affiliation", 
             value = Affiliation,
             overwrite = T)
```

## Show tables
```{sql connection=dbcon}
SELECT * FROM Journal
```

```{sql connection=dbcon}
SELECT * FROM Author
```

```{sql connection=dbcon}
SELECT * FROM History
```

```{sql connection=dbcon}
SELECT * FROM Article
```

```{sql connection=dbcon}
SELECT * FROM Write
```

```{sql connection=dbcon}
SELECT * FROM Affiliation
```

```{sql connection=dbcon}
SELECT * FROM Affiliate
```

# Part2
## Part2 Question1
![](/Users/zhaoyizhuang/5200/Practicum2/P2Q1.png)
```{sql connection=dbcon}
DROP TABLE IF EXISTS Journal_Dimension
```

```{sql connection=dbcon}
CREATE TABLE Journal_Dimension(
  ISSN TEXT NOT NULL,
  Title TEXT NOT NULL,
  PRIMARY KEY (ISSN)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Author_Dimension
```

```{sql connection=dbcon}
CREATE TABLE Author_Dimension(
  AuthorId TEXT NOT NULL,
  LastName TEXT NOT NULL,
  FirstName TEXT NOT NULL,
  Initials TEXT NOT NULL,
  PRIMARY KEY (AuthorId)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS History_Dimension
```

```{sql connection=dbcon}
CREATE TABLE History_Dimension(
  HistoryId TEXT NOT NULL,
  Year TEXT NOT NULL,
  Month TEXT NOT NULL,
  Day TEXT NOT NULL,
  PRIMARY KEY (HistoryId)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS AuthorList_Dimension
```

```{sql connection=dbcon}
CREATE TABLE AuthorList_Dimension(
  AuthorListId TEXT NOT NULL,
  PRIMARY KEY (AuthorListId)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Article_Fact
```

```{sql connection=dbcon}
CREATE TABLE Article_Fact(
  PMID TEXT NOT NULL,
  ISSN TEXT NOT NULL,
  Volume TEXT NOT NULL,
  Issue TEXT NOT NULL,
  ArticleTitle TEXT NOT NULL,
  HistoryId TEXT NOT NULL,
  AuthorListId TEXT NOT NULL,
  PRIMARY KEY (PMID),
  FOREIGN KEY (ISSN) REFERENCES Journal_Dimension(ISSN),
  FOREIGN KEY (AuthorListId) REFERENCES AuthorList_Dimension(AuthorListId),
  FOREIGN KEY (HistoryId) REFERENCES History_Dimension(HistoryId)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS AuthorList_Bridge
```

```{sql connection=dbcon}
CREATE TABLE AuthorList_Bridge(
  AuthorListId TEXT NOT NULL,
  AuthorId TEXT NOT NULL,
  PRIMARY KEY (AuthorListId, AuthorId),
  FOREIGN KEY (AuthorId) REFERENCES Author(AuthorId), 
  FOREIGN KEY (AuthorListId) REFERENCES AuthorList_Dimension(AuthorListId)
)
```

## Create History Dimension table based on the the PubStatus pubmed. 
## The Year Month and Day column are populated in the part 1 line 208
```{r}
History_Dimension <- cbind(Year, Month, Day, HistoryId)
```

## Populate the AuthorList_Dimension
```{r}
AuthorList_Dimension = 1:size
```

## Add AuthorListId to the Article_Fact
```{r}
Article_Fact <- cbind(Article, AuthorList_Dimension)
```

## Populate the AuthorList_Bridge
```{r}
AuthorList_Bridge <- cbind(AuthorList_Id, AuthorId)
```

## Overwrite tables to database
```{r}
dbWriteTable(conn = dbcon, 
             name = "Journal_Dimension", 
             value = data.frame(Journal),
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Author_Dimension", 
             value = data.frame(Author),
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "History_Dimension", 
             value = data.frame(History_Dimension),
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Article_Fact", 
             value = data.frame(Article_Fact),
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "AuthorList_Bridge", 
             value = data.frame(AuthorList_Bridge),
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "AuthorList_Dimension", 
             value = data.frame(AuthorList_Dimension),
             overwrite = T)
```

## Show tables
```{sql connection=dbcon}
SELECT * FROM History_Dimension
```

```{sql connection=dbcon}
SELECT * FROM Journal_Dimension
```

```{sql connection=dbcon}
SELECT * FROM AuthorList_Dimension
```

```{sql connection=dbcon}
SELECT * FROM AuthorList_Bridge
```

```{sql connection=dbcon}
SELECT * FROM Author_Dimension
```

```{sql connection=dbcon}
SELECT * FROM Article_Fact
```

## Part2 Question2
![](/Users/zhaoyizhuang/5200/Practicum2/P2Q2.png)
```{sql connection=dbcon}
DROP TABLE IF EXISTS Journal_Summary_Fact
```

```{sql connection=dbcon}
CREATE TABLE Journal_Summary_Fact(
  JounalSummaryId TEXT NOT NULL,
  ISSN TEXT NOT NULL,
  ArticleNumber Integer NOT NULL,
  Quarter TEXT NOT NULL,
  Year TEXT NOT NULL,
  PRIMARY KEY (JounalSummaryId),
  FOREIGN KEY (ISSN) REFERENCES Jounal_Dimension(ISSN)
)
```

```{sql connection=dbcon}
DROP TABLE IF EXISTS Author_Summary_Fact
```

```{sql connection=dbcon}
CREATE TABLE Author_Summary_Fact(
  AuthorSummaryId TEXT NOT NULL,
  AuthorId TEXT NOT NULL,
  ArticleNumber Integer NOT NULL,
  Quarter TEXT NOT NULL,
  Year TEXT NOT NULL,
  PRIMARY KEY (AuthorSummaryId),
  FOREIGN KEY (AuthorId) REFERENCES Author_Dimension(AuthorId)
)
```

## Populate the Journal_Summary_Fact table
```{r}



```

## Populate the Author_Summary_Fact table
```{r}

```

## Overwrite tables to database
```{r}
dbWriteTable(conn = dbcon, 
             name = "Journal_Summary_Fact", 
             value = data.frame(Journal_Summary_Fact),
             overwrite = T)

dbWriteTable(conn = dbcon, 
             name = "Author_Summary_Fact", 
             value = data.frame(Author_Summary_Fact),
             overwrite = T)
```



```{r}
dbDisconnect(dbcon)
```
